---
title: 各種可以繼續學下去的線索
image:
description:
keywords:
author: 'Opshell'
createdAt: 2025-10-31
categories:
  - '未分類'
tags:
  -
editLink: true
isPublished: false
---

# Vue 的 開發優化
Vue3{.vue} 社群中最推崇的 功能導向 (Feature-Oriented)

#
- 程式碼更健壯 (Robust)
- 程式碼異味 (Code Smell)
- Strategy Pattern
- Feature-Sliced Design (FSD) 的架構

# Code Review 衝突場景
- YAGNI (You Ain't Gonna Need It) 原則
- SSoT (Single Source of Truth) 完整性原則

- IIFE (立即執行函式)
- Floating Promise

<!-- import { ref } from 'vue'; // 如果未來需要 loading 狀態可以引入，目前純 JS 邏輯即可

const RECAPTCHA_URL = `https://www.google.com/recaptcha/enterprise.js?render=${__RECAPTCHA_SITE_KEY__}`; -->

<!-- // 使用 Promise 來保存載入狀態，而不僅僅是 boolean
// null = 未開始, Promise = 載入中或已完成
let loadPromise: Promise<void> | null = null; -->

```ts
export function useRecaptcha() {
    const siteKey = __RECAPTCHA_SITE_KEY__;

    /**
     * 負責載入 Script 的核心邏輯
     * 利用 Promise Singleton 模式解決 Race Condition
     */
    const loadScript = (): Promise<void> => {
        // 如果 window 中已經有物件，視為已載入 (可能是其他地方引入的)
        if (window.grecaptcha?.enterprise) {
            return Promise.resolve();
        }

        // 如果已經在載入中（但還沒完成），直接回傳同一個 Promise
        if (loadPromise) {
            return loadPromise;
        }

        // 開始新的載入流程
        loadPromise = new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = RECAPTCHA_URL;
            script.async = true;
            script.defer = true; // 建議加上 defer

            script.onload = () => {
                resolve();
            };

            script.onerror = (err) => {
                // 失敗時重置 promise，讓下次呼叫有機會重試
                loadPromise = null;
                console.error('[Recaptcha] Script load failed:', err);
                reject(err);
            };

            document.head.appendChild(script);
        });

        return loadPromise;
    };

    /**
     * 執行驗證並取得 Token
     */
    const execute = async (action: string = 'login'): Promise<string> => {
        try {
            await loadScript();

            if (!window.grecaptcha?.enterprise) {
                console.warn('[Recaptcha] grecaptcha.enterprise is missing after load.');
                return '';
            }

            return await new Promise<string>((resolve) => {
                window.grecaptcha!.enterprise.ready(async () => {
                    try {
                        const token = await window.grecaptcha!.enterprise.execute(siteKey, { action });
                        resolve(token);
                    } catch (error) {
                        console.error('[Recaptcha] Execution failed:', error);
                        // 根據業務需求，這裡可以 resolve('') 或是 throw error
                        resolve('');
                    }
                });
            });

        } catch (e) {
            console.error('[Recaptcha] Unexpected error:', e);
            return '';
        }
    };

    return { execute };
}
```
```ts
const execute = async (action: string = 'login'): Promise<string> => {
        try {
            await loadScript();

            if (!window.grecaptcha?.enterprise) {
                console.warn('[Recaptcha] grecaptcha.enterprise is missing after load.');
                return '';
            }

            return await new Promise<string>((resolve) => {
                // 1. 去掉這裡的 async，改成普通的箭頭函式
                window.grecaptcha!.enterprise.ready(() => {
                    // 2. 在這裡面啟動一個 async IIFE (Immediately Invoked Function Expression)
                    // 這樣 ready 接收到的是 void，而我們在內部自行處理 Promise
                    (async () => {
                        try {
                            const token = await window.grecaptcha!.enterprise.execute(siteKey, { action });
                            resolve(token);
                        } catch (error) {
                            console.error('[Recaptcha] Execution failed:', error);
                            resolve('');
                        }
                    })();
                });
            });

        } catch (e) {
            console.error('[Recaptcha] Unexpected error:', e);
            return '';
        }
    };
    ```